# 问题明确
总共有$m$个个体，每个个体$i$具有两类耗电类型，分别为电车充电EV和非电车充电non-EV
$d_i \in R^{24}$代表第$i$个个体在24小时内的non-EV 耗电功率曲线向量，单位kwh，常量；

$x_i \in R^{24}$代表第$i$个个体在24小时内EV 单位时间（1h）耗电功率曲线向量，单位kwh，变量；$x_i$的元素和为$E_i$，表示该电车的容量

$x_{i, max} \in R^{24}$代表第$i$个个体在24小时内 单位时间(1h) EV 耗电功率的峰值，单位kwh，常量


对于社会来说，总的电费价格可以表示为如下的损失函数：
$$
F(x)=p(r)^T (\sum_{i=1}^{m}x_i + d)
$$
其中：
$d=\sum_{i=1}^{m}d_i$ ,表示总的非EV耗电
$p(r): R^{24} \rightarrow R^{24}$，表示的是各时段的电价，是一个凸的单调增函数，$r=\frac{1}{C_{tol}}{\sum_{i=1}^{m}x_i+d}$，与各时段耗电量总量和总储备电量$C_{tol}$的比值有关。

可以发现，对于个人$i$来说，他所需要支付的电费不仅与自身耗电量有关($x_i$)，还与整体所有人的耗电量有关（$\phi(x)$，影响价格），将损失函数重写为：
$$
\begin{aligned}
F(x)&=\sum_{i=1}^{m}f_i(x_i, \phi(x))
\end{aligned}
$$
其中，$f_i(x_i, \phi(x))=p(\phi(x))^T(x_i+d_i)$表示的是每个个体所需要承担的电费，$\phi(x)=\frac{1}{C_{tot}}\sum_{i=1}^{m}(x_i+d_i)=\frac{1}{m}\sum_{i=1}^{m}g_i(x)$
其中 $g_i(x)=\frac{m}{C_{tot}}\sum_{i=1}^{m}(x_i+d_i)$

可以看出，对于个人来说，可以根据$f_i(x_i, \phi(x))$求解出$x_i^*$；而对于整体来说，可以根据$F(x)$求解出$x^*$.

**区分两个最优点**：
1. $\tilde{x}^* \in R^{24\times m}=(x_1^*, x_2^*, x_3^*,...,x_m^*)$表示从个人角度出发，每个人都取最优的点
2. $x^*\in R^{24\times m}$表示从社会角度出发，全局最优点，注意维度


# 0x01 Homogeneous: Same $E_i$ and $d_i$


# 0x02 Heterogeneous: Hierarchical $E_i$ and $d_i$

疑问：
1. $d_i$按照相同的形式进行划分的意思是什么？d%的$d$分配给m%的$m$，则人均$d_i$还是相同
2. 不同的$E_i$限制了$x_i$的不同，此时全局最优解$x^*$如何满足不同的$E_i$---==澄清，$x^*$并非与$x_i$同纬度，而是使得$F$损失最小的各$x_i$值的concatenate==

## 算法迭代

问题：
1. 算法中的$\Omega{t}$没定义，没有使用
2. 目前算法结果，各时段用电值很平均，感觉不对
3. 算法结果依赖于初始值的选取（初始值相同的的时候，最后$x^*$结果各时段值就完全相同），作为对比，尝试了scipy中minimize库的不同初始值
   * 全0：
   ![[Pasted image 20241116173541.png]]
   * 全10
     ![[Pasted image 20241117104050.png]]
   * 0-1随机：
     ![[Pasted image 20241116173710.png]]
   * 0-10随机:
     ![[Pasted image 20241116174207.png]]
    * 0-20随机：
      ![[Pasted image 20241116174246.png]]
	但是不同情况下损失$f_i$差距很小，同样的情况发生在全局求解中

在超参数相同的情况下（迭代算法自身具有的除外）对比直接优化与算法迭代：


# 1204
**关于两个算法最终收敛值的问题**
1. 算法检查，未发现错误
2. 实验结果表明，Algorithm 1效果可能较优
   * 当改变`user.x`的初始值时，Xiuxian算法收敛值不同（改变步长时，Xiuxian算法收敛速率发生变化，但收敛值相同。）
     ![[Pasted image 20241204172558.png]]
     而Algorithm 1的收敛值十分接近
     ![[Pasted image 20241204172426.png]]
	* 当采用
	  ```python
		self.x = np.random.uniform(0, 4, T)
		```
		进行随机初始化时，Algorithm 1的loss比Xiuxian的低，结果图相较于Xiuxian的也更符合实际
		![[Pasted image 20241204172931.png]]
		![[Pasted image 20241204172944.png]]
	

